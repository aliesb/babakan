<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ุซุจุช ูุฏุฏุฌู ุฌุฏุฏ</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css"> <link rel="stylesheet" href="https://unpkg.com/persian-datepicker/dist/css/persian-datepicker.min.css">
</head>
<body>
    <aside>
        <h2>ููู ุณุงูุงูู</h2>
        <div class="date-display">
            <span id="today-date"></span>
            <span id="today-day"></span>
        </div>
        <a href="dashboard.html" class="">๐ ุฏุงุดุจูุฑุฏ</a>
        <a href="patients.html" class="">๐ ูุณุช ุจูุงุฑุงู</a>
        <div id="search-container">
            <input type="text" id="search-box" placeholder="ุฌุณุชุฌู ุจูุงุฑ..." autocomplete="off">
            <div id="search-results">
                <ul></ul>
            </div>
        </div>
        <a href="add-patient.html" class="active">โ ุซุจุช ูุฏุฏุฌู</a>
        <a href="medications.html">๐ ูุฏุฑุช ุฏุงุฑู</a>
        <a href="#" onclick="logout()">๐ช ุฎุฑูุฌ</a>
    </aside>

    <main>
        <header>โ ุซุจุช ูุฏุฏุฌู ุฌุฏุฏ</header>
        <form id="patientForm" class="patient-form-grid" onsubmit="submitPatient(event)">
            <fieldset class="form-fieldset">
                <legend>ุงุทูุงุนุงุช ูุฑุฏ</legend>
                <div class="form-group">
                    <label for="fileNumber">ุดูุงุฑู ูพุฑููุฏู</label>
                    <input type="text" id="fileNumber" required>
                </div>
                <div class="form-group">
                    <label for="fullName">ูุงู ู ูุงู ุฎุงููุงุฏฺฏ</label>
                    <input type="text" id="fullName" required>
                </div>
                <div class="form-group">
                    <label for="nationalId">ฺฉุฏ ูู</label>
                    <input type="text" id="nationalId" required>
                </div>
                <div class="form-group">
                    <label for="phone">ุดูุงุฑู ุชูุงุณ</label>
                    <input type="tel" id="phone" required>
                </div>
                <div class="form-group">
                    <label for="birthdate">ุณุงู ุชููุฏ</label>
                    <input type="number" id="birthdate" min="1300" max="1450">
                </div>
            </fieldset>

            <fieldset class="form-fieldset">
                <legend>ุงุทูุงุนุงุช ุฏุฑูุงู</legend>
                <div class="form-group">
                    <label for="treatmentType">ููุน ุฏุฑูุงู</label>
                    <select id="treatmentType">
                        <option value="opium">ุงูพูู</option>
                        <option value="methadone">ูุชุงุฏูู</option>
                        <option value="bup">ุจููพุฑูููุฑูู</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dose">ุฏูุฒ ูุตุฑู ุฑูุฒุงูู</label>
                    <input type="text" id="dose">
                </div>
                <div class="form-group">
                    <label for="startDate">ุชุงุฑุฎ ุดุฑูุน ุฏุฑูุงู</label>
                    <input type="text" id="startDate" data-jdp required> </div>
                <div class="form-group">
                    <label for="notes">ุงุฏุฏุงุดุช ุชฺฉูู</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>
            </fieldset>

            <button type="submit" class="btn btn-primary">ุซุจุช ุงุทูุงุนุงุช ูุฏุฏุฌู</button>
        </form>
    </main>

    <script src="https://unpkg.com/persian-date/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker/dist/js/persian-datepicker.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, Timestamp, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getStorage } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js';
        // import { toDateObject } from './date-converter.js'; // ุงู ูุงู ุฏฺฏุฑ ูุงุฒ ูุณุช ุงฺฏุฑ birthdate ุฑุง ุจู ุตูุฑุช ูุณุชูู ุฐุฎุฑู ูโฺฉูู

        // ุงุณุชูุงุฏู ุงุฒ firebaseConfig ุงุฒ ูุงู ุฌุฏุงฺฏุงูู
        import { firebaseConfig } from './firebase-config.js'; // ูุฑุถ ุจุฑ ุงู ุงุณุช ฺฉู ุงู ูุงู ุฏุฑ ฺฉูุงุฑ ูุงู HTML ุดูุง ูุฑุงุฑ ุฏุงุฑุฏ.

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = "login.html";
            }
        });

        function logout() {
            auth.signOut().then(() => {
                window.location.href = "login.html";
            }).catch(error => {
                console.error("Logout error:", error);
                alert("Failed to logout. Please try again.");
            });
        }

        async function submitPatient(event) {
            event.preventDefault();

            const fileNumber = document.getElementById('fileNumber').value;
            const fullName = document.getElementById('fullName').value;
            const nationalId = document.getElementById('nationalId').value;
            const phone = document.getElementById('phone').value;
            const birthdateInput = document.getElementById('birthdate').value;
            const treatmentType = document.getElementById('treatmentType').value;
            const dose = document.getElementById('dose').value;
            const startDate = document.getElementById('startDate').value; // ุงู ุงูุงู ุชุงุฑุฎ ุดูุณ ุงุณุช
            const notes = document.getElementById('notes').value;

            // ุชุจุฏู ุณุงู ุชููุฏ ุจู ุดูุณ (ุฏุฑ ุตูุฑุช ฺฉู ูุฑูุฏ ุดูุณ ุจุงุดุฏ)
            let birthYear = birthdateInput; // ูุฑุถ ูโฺฉูู birthdateInput ุณุงู ุดูุณ ุงุณุช

            const formData = {
                file_number: fileNumber,
                name: fullName,
                national_id: nationalId,
                phone: phone,
                birthdate: birthYear,
                treatment_type: treatmentType,
                dose: dose,
                start_date: startDate, // ุชุงุฑุฎ ุดูุณ ุงุฒ ุชููู
                notes: notes,
                createdAt: Timestamp.now()
            };

            console.log("Form data:", formData);

            try {
                const docRef = await addDoc(collection(db, "patients"), formData);
                console.log("Patient inserted successfully with ID: ", docRef.id);
                alert("โ ูุฏุฏุฌู ุจุง ููููุช ุซุจุช ุดุฏ.");
                document.getElementById('patientForm').reset();

            } catch (error) {
                console.error("Error:", error);
                alert("An unexpected error occurred: " + error.message);
            }
        }

        function displayCurrentDate() {
            const today = new Date();
            // ุงุณุชูุงุฏู ุงุฒ persian-date ุจุฑุง ููุงุด ุชุงุฑุฎ ุดูุณ ฺฉุงูู ู ุฏูู
            const pdate = new persianDate(today);
            const jalaliDate = pdate.format('dddd DD MMMM YYYY');
            const dayName = pdate.format('dddd');
            const formattedDate = jalaliDate.replace(dayName, '').trim();

            document.getElementById('today-date').textContent = formattedDate;
            document.getElementById('today-day').textContent = dayName;
        }

        displayCurrentDate();

        // ููุฏุงุฑุฏู ุงููู datepicker
        $(document).ready(function() {
            $("#startDate").pDatepicker({
                format: 'YYYY/MM/DD',
                initialValueType: "persian",
                onSelect: function (unix) {
                    const selectedDate = new persianDate(unix).format('YYYY/MM/DD');
                    document.getElementById('startDate').value = selectedDate;
                }
            });
        });

        const searchBox = document.getElementById('search-box');
        const searchResultsContainer = document.getElementById('search-results');
        let allPatients = [];

        async function fetchPatients() {
            try {
                const patientsSnapshot = await getDocs(collection(db, "patients"));
                allPatients = patientsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error("Error fetching patients:", error);
                alert("Failed to fetch patients. Please try again.");
            }
        }

        function findMatches(searchTerm, patients) {
            if (!searchTerm) return [];
            const regex = new RegExp(searchTerm, 'i');
            return patients.filter(patient => {
                return regex.test(patient.name) || regex.test(patient.file_number);
            });
        }

        function displayMatches() {
            const matchArray = findMatches(this.value, allPatients);
            const resultsHTML = matchArray.map(patient => {
                return `
                    <li data-id="${patient.id}">
                        ${patient.name} - ${patient.file_number}
                    </li>
                `;
            }).join('');
            searchResultsContainer.innerHTML = resultsHTML || `<li class="no-results">ุจูุงุฑ ุงูุช ูุดุฏ.</li>`;
            searchResultsContainer.style.display = this.value ? 'block' : 'none';
        }

        searchResultsContainer.addEventListener('click', (event) => {
            const patientId = event.target.dataset.id;
            if (patientId) {
                console.log(`Selected patient ID: ${patientId}`);
                window.location.href = `patient-profile.html?id=${patientId}`;
            }
            searchResultsContainer.style.display = 'none';
            searchBox.value = '';
        });

        searchBox.addEventListener('input', displayMatches);

        window.addEventListener('load', async () => {
            await fetchPatients();
        });
    </script>
</body>
</html>
